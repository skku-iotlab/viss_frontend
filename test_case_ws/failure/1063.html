<!DOCTYPE HTML>
<html>
<link rel="shortcut icon" href="#">
<meta charset="utf-8">
<title>
    [1063: Search read a vss datapoint with an expired token]
</title>
<link rel="help" href="https://www.w3.org/TR/vehicle-information-service/#idl-def-getrequest">
<link rel="stylesheet" type="text/css" href="/css/style-general.css">
<script src="/js/testharness.js"></script>
<script src="/js/testharnessreport.js"></script>
<script src="/js/vehicle-test-config.js"></script>
<script src="/js/vehicle-test-helper.js"></script>

<div id="test-title">
    [1063: Search read a vss datapoint with an expired token]
</div>
<br>
<div id="test-assertion">
    <b>Test assertion:</b><br>
    When the client makes a request with a correct 'get' action<br>
    without wildcards to the server,<br>
    a JSON data object defined as 'getSuccessResponse' is returned.<br>
</div>
<div id="scenario">
    <br>
    <b>Test Scenario:</b><br>
    1. Execute 'get' method specifing a data path and requestId.<br>
    (e.g. 'Signal.Drivetrain.Transmission.Speed')<br>
    2. Confirm 'GetSuccessResponse' containing the specified requestId.<br>
    <br>
    <b>Expected Result:</b><br>
    - Received 'GetSuccessResponse' containing specified requestId. <br>
</div>
<div id="request"></div>

<div id="result"></div>
<br>
<script>
    var t = async_test("Get success case");
    var vehicle = new WebSocket("ws://localhost:3001");
    //3001 : secured
    let access_token = ""
    var request_json = ""


    function getResponseHeaderMap(xhr) {
        const headers = {};
        xhr.getAllResponseHeaders()
            .trim()
            .split(/[\r\n]+/)
            .map(value => value.split(/: /))
            .forEach(keyValue => {
                headers[keyValue[0].trim()] = keyValue[1].trim();
            });
        return headers;
    }


    function getAccessToken() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var response_data = JSON.parse(this.response);
                access_token = response_data['access']
                var header = getResponseHeaderMap(this)
            }
        };
        // REST API 
        let request = "POST"
        let protocol = "http"
        let host = "127.0.0.1:8000"
        let path = "api/token"
        let url = protocol + "://" + host + "/" + path
        let data = new FormData();
        data.append('username', 'skku');
        data.append('password', 'skku');
        xhttp.open(request, url, false);
        xhttp.send(data);
    }

    function showRES_success(Or_msg) {
        var msg = document.getElementById('result').innerHTML;
        msg = "<br>"
            + '<div style="font-size:20px; background-color:#00CC00;">'
            + "SUCCESS : " + JSON.stringify(Or_msg)
            + '</div>';
        document.getElementById('result').innerHTML = msg;
    }

    function showRES_failure(Or_msg) {
        var msg = document.getElementById('result').innerHTML;
        msg = "<br>"
            + '<div style="font-size:20px; background-color:#FF0000;">'
            + "FAILURE : " + JSON.stringify(Or_msg)
            + '</div>';
        document.getElementById('result').innerHTML = msg;
    }

    function showREQ(Or_msg) {
        var rq_msg = document.getElementById('request').innerHTML;
        rq_msg = "<br>"
            + '<div style="font-size:20px; background-color:#E56D29;">'
            + "REQUEST : " + request_json
            + '</div>';
        document.getElementById('request').innerHTML = rq_msg;
    }


    function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }
    //https://stackoverflow.com/questions/951021/what-is-the-javascript-version-of-sleep



    vehicle.onopen = function () {
        vehicle.onmessage = function (event) {
            var success
            t.step_func(function () {
                success = isGetSuccessResponse(event.data)
                if (success) {
                    helper_terminate_success("Get response received. ", event.data);
                } else {
                    console.log(event.data)
                    helper_terminate_failure("Get method failed", event.data);
                }
            })();
            // var Or_msg = JSON.parse(event.data);
            // if ((event.data).includes("error")) {
            //     showRES_failure(Or_msg)
            // } else {
            //     showRES_success(Or_msg)
            // }
        }

        getAccessToken()
        request_json = '{"action":"get","path":"Vehicle/Cabin/Door","filter":{"op-type":"paths","op-value":"*/*/IsOpen"},"authorization":"' + access_token + '","requestId":"5688"}';
        //setting.py => 'ACCESS_TOKEN_LIFETIME': datetime.timedelta(seconds=1), => token 발급하고 1.5초 이후에 vehicle send -> expired token !
        showREQ(request_json)   
        sleep(1500).then(() => {
            vehicle.send(request_json);
        });
    }


</script>

</html>